<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 12px 20px;
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: #d1d4dc;
        }

        .legend {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 3px;
            border-radius: 1px;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #main-chart {
            flex: 3;
            width: 100%;
            position: relative;
        }

        #sub-chart {
            flex: 1;
            width: 100%;
            border-top: 1px solid #2a2e39;
        }

        .ohlc-panel {
            position: absolute;
            top: 8px;
            left: 10px;
            padding: 8px 12px;
            background: rgba(30, 34, 45, 0.9);
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .ohlc-item {
            display: flex;
            gap: 4px;
        }

        .ohlc-label {
            color: #787b86;
        }

        .ohlc-value {
            font-weight: 500;
        }

        .ohlc-value.up {
            color: #26a69a;
        }

        .ohlc-value.down {
            color: #ef5350;
        }

        .ohlc-date {
            color: #d1d4dc;
            margin-right: 10px;
        }

        .features-panel {
            position: absolute;
            bottom: 8px;
            left: 10px;
            padding: 6px 10px;
            background: rgba(30, 34, 45, 0.9);
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
            display: flex;
            gap: 10px;
        }

        .feature-item {
            display: flex;
            gap: 3px;
        }

        .feature-label {
            color: #787b86;
        }

        .feature-value {
            font-weight: 500;
            color: #d1d4dc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>{{title}}</h1>
            <div class="legend" id="legend"></div>
        </div>
        <div class="chart-area">
            <div id="main-chart">
                <div class="ohlc-panel" id="ohlc-panel"></div>
            </div>
            <div id="sub-chart">
                <div class="features-panel" id="features-panel"></div>
            </div>
        </div>
    </div>

    <script>
        // 数据 (由 Python 注入)
        const candlestickData = {{ candlestick_json }};
        const featuresData = {{ features_json }};
        const pricePrecision = {{ precision }};

        // 特征配置
        const featureConfig = {
            'body_pct': { color: '#4ECDC4', label: 'Body%' },
            'close_pos': { color: '#FFA500', label: 'ClsPos' },
            'rel_size': { color: '#FF6B6B', label: 'RelSz' },
            'upper_tail_pct': { color: '#96CEB4', label: 'UpTail' },
            'lower_tail_pct': { color: '#45B7D1', label: 'LowTail' },
        };

        // ========================================
        // 主图表 (OHLC 蜡烛图)
        // ========================================
        const mainContainer = document.getElementById('main-chart');
        const mainChart = LightweightCharts.createChart(mainContainer, {
            layout: {
                background: { type: 'solid', color: '#131722' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#1e222d' },
                horzLines: { color: '#1e222d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                    labelBackgroundColor: '#2a2e39',
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                    labelBackgroundColor: '#2a2e39',
                },
            },
            rightPriceScale: {
                borderColor: '#2a2e39',
                mode: LightweightCharts.PriceScaleMode.Logarithmic,
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
                borderColor: '#2a2e39',
                timeVisible: false,
                rightOffset: 5,
                tickMarkFormatter: (time) => {
                    const date = new Date(time * 1000);
                    const yy = String(date.getFullYear()).slice(-2);
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yy}-${mm}-${dd}`;
                },
            },
            handleScroll: { vertTouchDrag: false },
            handleScale: { mouseWheel: false },
        });

        // OHLC 蜡烛图系列
        const candleSeries = mainChart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderUpColor: '#26a69a',
            borderDownColor: '#ef5350',
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });
        candleSeries.setData(candlestickData);

        // ========================================
        // 副图表 (Bar Features)
        // ========================================
        const subContainer = document.getElementById('sub-chart');
        const subChart = LightweightCharts.createChart(subContainer, {
            layout: {
                background: { type: 'solid', color: '#131722' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#1e222d' },
                horzLines: { color: '#1e222d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: { visible: false },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                    labelBackgroundColor: '#2a2e39',
                },
            },
            rightPriceScale: {
                borderColor: '#2a2e39',
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
                visible: false,  // 隐藏时间轴，由主图控制
            },
            handleScroll: { vertTouchDrag: false },
            handleScale: { mouseWheel: false },
        });

        // 添加特征线
        const featureSeries = {};
        const legendContainer = document.getElementById('legend');

        Object.keys(featureConfig).forEach(key => {
            if (!featuresData[key]) return;

            const config = featureConfig[key];
            const series = subChart.addLineSeries({
                color: config.color,
                lineWidth: 1.5,
                crosshairMarkerVisible: true,
                lastValueVisible: false,
                priceLineVisible: false,
            });

            const data = featuresData[key].map((v, i) => ({
                time: candlestickData[i].time,
                value: v,
            })).filter(d => d.value !== null && !isNaN(d.value));

            series.setData(data);
            featureSeries[key] = series;

            // 添加图例
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <div class="legend-color" style="background: ${config.color}"></div>
                <span>${config.label}</span>
            `;
            legendContainer.appendChild(legendItem);
        });

        // ========================================
        // 同步两个图表的时间轴
        // ========================================
        mainChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
            if (range) {
                subChart.timeScale().setVisibleLogicalRange(range);
            }
        });

        subChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
            if (range) {
                mainChart.timeScale().setVisibleLogicalRange(range);
            }
        });

        // ========================================
        // 自定义滚轮缩放
        // ========================================
        function handleWheel(chart, container) {
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const timeScale = chart.timeScale();
                const visibleRange = timeScale.getVisibleLogicalRange();
                if (!visibleRange) return;

                const containerRect = container.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const chartWidth = containerRect.width;

                const mouseRatio = mouseX / chartWidth;
                const rangeLength = visibleRange.to - visibleRange.from;
                const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                const newRangeLength = rangeLength * zoomFactor;

                if (newRangeLength < 10 || newRangeLength > candlestickData.length) return;

                const mouseLogicalPos = visibleRange.from + rangeLength * mouseRatio;
                const newFrom = mouseLogicalPos - newRangeLength * mouseRatio;
                const newTo = mouseLogicalPos + newRangeLength * (1 - mouseRatio);

                mainChart.timeScale().setVisibleLogicalRange({ from: newFrom, to: newTo });
            }, { passive: false });
        }

        handleWheel(mainChart, mainContainer);
        handleWheel(subChart, subContainer);

        // ========================================
        // OHLC 和 Features 面板更新
        // ========================================
        const ohlcPanel = document.getElementById('ohlc-panel');
        const featuresPanel = document.getElementById('features-panel');

        function updatePanels(time) {
            const idx = candlestickData.findIndex(d => d.time === time);
            if (idx === -1) {
                ohlcPanel.innerHTML = '';
                featuresPanel.innerHTML = '';
                return;
            }

            const data = candlestickData[idx];
            const date = new Date(time * 1000);
            const dateStr = date.toISOString().split('T')[0];
            const isUp = data.close >= data.open;
            const colorClass = isUp ? 'up' : 'down';

            ohlcPanel.innerHTML = `
                <span class="ohlc-date">${dateStr}</span>
                <div class="ohlc-item"><span class="ohlc-label">O:</span><span class="ohlc-value ${colorClass}">${data.open.toFixed(pricePrecision)}</span></div>
                <div class="ohlc-item"><span class="ohlc-label">H:</span><span class="ohlc-value ${colorClass}">${data.high.toFixed(pricePrecision)}</span></div>
                <div class="ohlc-item"><span class="ohlc-label">L:</span><span class="ohlc-value ${colorClass}">${data.low.toFixed(pricePrecision)}</span></div>
                <div class="ohlc-item"><span class="ohlc-label">C:</span><span class="ohlc-value ${colorClass}">${data.close.toFixed(pricePrecision)}</span></div>
            `;

            // Features 面板
            let featuresHtml = '';
            Object.keys(featureConfig).forEach(key => {
                if (!featuresData[key]) return;
                const val = featuresData[key][idx];
                if (val !== null && !isNaN(val)) {
                    const config = featureConfig[key];
                    featuresHtml += `
                        <div class="feature-item">
                            <span class="feature-label">${config.label}:</span>
                            <span class="feature-value" style="color:${config.color}">${val.toFixed(2)}</span>
                        </div>
                    `;
                }
            });
            featuresPanel.innerHTML = featuresHtml;
        }

        mainChart.subscribeCrosshairMove((param) => {
            if (param.time) {
                updatePanels(param.time);
            }
        });

        subChart.subscribeCrosshairMove((param) => {
            if (param.time) {
                updatePanels(param.time);
            }
        });

        // ========================================
        // 自适应大小
        // ========================================
        const resizeObserver = new ResizeObserver(() => {
            mainChart.applyOptions({
                width: mainContainer.clientWidth,
                height: mainContainer.clientHeight,
            });
            subChart.applyOptions({
                width: subContainer.clientWidth,
                height: subContainer.clientHeight,
            });
        });
        resizeObserver.observe(mainContainer);
        resizeObserver.observe(subContainer);

        // 初始显示最后 120 根 K 线
        if (candlestickData.length > 120) {
            mainChart.timeScale().setVisibleLogicalRange({
                from: candlestickData.length - 120,
                to: candlestickData.length - 1,
            });
        }

        // 双击重置视图
        mainContainer.addEventListener('dblclick', () => {
            mainChart.timeScale().fitContent();
            mainChart.priceScale('right').applyOptions({
                scaleMargins: { top: 0.1, bottom: 0.1 },
            });
        });
    </script>
</body>

</html>